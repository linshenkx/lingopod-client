<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>LingoPod</title>
    <link href="lib/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link href="lib/css/all.min.css" rel="stylesheet">
    <link rel="icon" href="data:,">  <!-- æ·»åŠ è¿™è¡Œæ¥é˜»æ­¢ favicon è¯·æ±‚ -->
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/player.css">
</head>
<body>
    <button class="theme-toggle" id="themeToggle">ğŸŒ“</button>
    <div class="container" id="mainPage">
        <h1 class="text-center mb-4">LingoPod è¯‘æ’­å®¢</h1>
        <div class="card mb-4">
            <div class="card-body">
                <h2>åˆ›å»ºæ–°æ’­å®¢</h2>
                <form id="urlForm">
                    <div class="mb-3">
                        <input type="url" id="urlInput" class="form-control" required placeholder="è¾“å…¥URL">
                    </div>
                    <button type="submit" class="btn btn-primary w-100">æäº¤ä»»åŠ¡</button>
                </form>
                <div id="taskInfo" class="mt-4"></div>
            </div>
        </div>
        <div class="mb-3">
            <input type="text" id="searchInput" class="form-control" placeholder="æœç´¢æ’­å®¢...">
        </div>
        <div id="audioList"></div>
    </div>

    <div class="player-container" id="playerPage" style="display: none;">
        <div class="player-header">
            <button id="backBtn" class="btn-back">
                <i class="fas fa-chevron-down"></i>
            </button>
        </div>
        <div class="player-content">
            <div class="player-main">
                <h2 id="playerTitle" class="player-title mb-3">æ­£åœ¨æ’­æ”¾</h2>
                
                <div class="subtitle-container">
                    <div id="subtitleTextCn" class="subtitle-text"></div>
                    <div id="subtitleTextEn" class="subtitle-text"></div>
                </div>
                
                <div class="player-controls">
                    <input type="range" class="player-progress" id="progressBar" min="0" max="100" value="0">
                    <div class="player-time">
                        <span id="currentTime">00:00</span>
                        <span id="duration">00:00</span>
                    </div>
                    <div class="player-buttons">
                        <button class="btn-player" id="prevBtn"><i class="fas fa-step-backward"></i></button>
                        <button class="btn-player btn-play" id="playPauseBtn"><i class="fas fa-play"></i></button>
                        <button class="btn-player" id="nextBtn"><i class="fas fa-step-forward"></i></button>
                        <button class="btn-player" id="speedBtn">1x</button>
                        <button class="btn-player" id="languageBtn">ä¸­æ–‡</button>
                        <button class="btn-player" id="subtitleBtn">å­—å¹•: ä¸­è‹±æ–‡</button>
                    </div>
                </div>
            </div>
            <div class="player-playlist" id="playlist"></div>
        </div>
    </div>

    <div class="mini-player" id="miniPlayer" style="display: none;">
        <div class="mini-player-info">
            <div class="mini-player-title" id="miniPlayerTitle"></div>
            <div class="mini-player-progress">
                <input type="range" class="form-range" id="miniProgressBar" min="0" max="100" value="0">
                <div class="mini-player-time">
                    <span id="miniCurrentTime">00:00</span>
                    <span id="miniDuration">00:00</span>
                </div>
            </div>
        </div>
        <div class="mini-player-controls">
            <button class="mini-player-btn" id="miniPrevBtn"><i class="fas fa-step-backward"></i></button>
            <button class="mini-player-btn" id="miniPlayPauseBtn"><i class="fas fa-play"></i></button>
            <button class="mini-player-btn" id="miniNextBtn"><i class="fas fa-step-forward"></i></button>
            <button class="mini-player-btn" id="miniSpeedBtn">1x</button>
            <button class="mini-player-btn" id="miniLanguageBtn">ä¸­æ–‡</button>
            <button class="mini-player-btn" id="miniOpenPlayerBtn"><i class="fas fa-expand"></i></button>
        </div>
    </div>

    <!-- åœ¨åº•éƒ¨ -->
    <script src="lib/js/howler.min.js"></script>
    <script src="lib/js/jquery.min.js"></script>
    <script>
        $(document).ready(function() {
            const API_BASE_URL = '/api';
            let audioList = [];
            let currentAudioIndex = -1;
            let sound = null;
            let currentLanguage = 'cn'; // æ–°å¢ï¼šå½“å‰è¯­è¨€
            let subtitles = { cn: [], en: [] }; // æ–°å¢ï¼šå‚¨ä¸­è‹±æ–‡å­—å¹•
            let currentTaskId = null;
            let subtitleMode = 'both'; // 'cn', 'en', 'both'

            function fetchAudios() {
                console.log('Fetching audios...'); // åŠ æ—¥å¿—
                $.ajax({
                    url: `${API_BASE_URL}/get_list`,
                    method: 'GET',
                    success: function(data) {
                        console.log('Received audio data:', data); // æ·»åŠ æ—¥å¿—
                        audioList = data.filter(audio => audio.audioUrlCn || audio.audioUrlEn);
                        console.log('Filtered audio list:', audioList); // æ·»åŠ æ—¥å¿—
                        displayAudios(audioList);
                    },
                    error: function(error) {
                        console.error('è·å–éŸ³é¢‘åˆ—è¡¨å¤±è´¥:', error);
                    }
                });
            }

            function displayAudios(audios) {
                console.log('Displaying audios:', audios); // æ·»åŠ æ—¥å¿—
                const $audioList = $('#audioList');
                $audioList.empty();

                if (audios.length === 0) {
                    console.log('No audios to display'); // æ·»åŠ æ—¥å¿—
                    $audioList.append('<p>æ²¡æœ‰å¯ç”¨çš„éŸ³é¢‘</p>');
                    return;
                }

                audios.forEach((audio, index) => {
                    if (!audio.audioUrlCn && !audio.audioUrlEn) {
                        console.log('Skipping audio without URL:', audio); // æ·»åŠ æ—¥å¿—
                        return;
                    }

                    const createdAt = new Date(audio.createdAt);
                    const formattedDate = `${createdAt.getFullYear()}/${(createdAt.getMonth() + 1).toString().padStart(2, '0')}/${createdAt.getDate().toString().padStart(2, '0')} ${createdAt.getHours().toString().padStart(2, '0')}:${createdAt.getMinutes().toString().padStart(2, '0')}:${createdAt.getSeconds().toString().padStart(2, '0')}`;

                    const $audioItem = $('<div>').addClass('audio-item').html(`
                        <div class="audio-info">
                            <a href="${audio.url}" target="_blank" class="audio-title">${audio.title || 'æ— æ ‡é¢˜'}</a>
                            <div class="audio-meta">
                                <span class="ml-2">${formattedDate}</span>
                            </div>
                        </div>
                        <button class="btn btn-primary btn-play">
                            <i class="fas fa-play"></i>
                        </button>
                        <button class="btn btn-danger btn-delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    `);

                    $audioItem.find('.btn-play').on('click', function() {
                        playAudio(index);
                        // ç‚¹å‡»æ’­æ”¾æŒ‰é’®æ—¶åªæ˜¾ç¤ºminiæ’­æ”¾å™¨
                        $('#mainPage').show();
                        $('#playerPage').hide();
                        $('#miniPlayer').show();
                    });

                    $audioItem.find('.btn-delete').on('click', function() {
                        deleteAudio(audio.taskId);
                    });

                    $audioList.append($audioItem);
                });

                console.log('Audio list updated'); // æ·»åŠ æ—¥å¿—
                handleSearch();
                updatePlaylist();
            }

            function playAudio(index, forceReload = false) {
                console.log('å¼€å§‹æ’­æ”¾éŸ³é¢‘ï¼Œç´¢å¼•:', index, 'å¼ºåˆ¶é‡è½½:', forceReload);
                if (currentAudioIndex === index && sound && !forceReload) {
                    if (sound.playing()) {
                        sound.pause();
                    } else {
                        sound.play();
                    }
                    return;
                }
                
                currentAudioIndex = index;
                const audio = audioList[index];
                const audioUrl = currentLanguage === 'cn' ? audio.audioUrlCn : audio.audioUrlEn;
                
                if (sound) {
                    sound.unload();
                }
                
                subtitles = { cn: [], en: [] };
                $('#subtitleTextCn').text('');
                $('#subtitleTextEn').text('');
                
                // åŠ è½½å½“å‰è¯­è¨€çš„å­—å¹•
                if (currentLanguage === 'cn' && audio.subtitleUrlCn) {
                    loadSubtitles(audio.subtitleUrlCn, 'cn');
                } else if (currentLanguage === 'en' && audio.subtitleUrlEn) {
                    loadSubtitles(audio.subtitleUrlEn, 'en');
                }
                
                sound = new Howl({
                    src: [audioUrl],
                    html5: true,
                    format: ['mp3'],
                    onplay: function() {
                        console.log('éŸ³é¢‘å¼€å§‹æ’­æ”¾');
                        startProgressUpdate();
                        updatePlayerControls();
                        $('#playPauseBtn i, #miniPlayPauseBtn i')
                            .removeClass('fa-play')
                            .addClass('fa-pause');
                        
                        const savedSpeed = parseFloat(localStorage.getItem('audioPlaybackSpeed')) || 1;
                        sound.rate(savedSpeed);
                        updateSpeed(savedSpeed);
                    },
                    onpause: function() {
                        console.log('éŸ³é¢‘æš‚åœ');
                        stopProgressUpdate();
                        $('#playPauseBtn i, #miniPlayPauseBtn i')
                            .removeClass('fa-pause')
                            .addClass('fa-play');
                    },
                    onend: function() {
                        stopProgressUpdate();
                        playNext();
                    },
                    onseek: function() {
                        console.log('éŸ³é¢‘seekäº‹ä»¶è§¦å‘');
                        updateProgressBar();
                    }
                });
                
                sound.on('seek', function() {
                    updateProgressBar();
                });
                
                sound.play();
                updatePlaylist();
                updatePlayerControls();
                
                $('#playerTitle').text(audio.title || 'æ— æ ‡é¢˜');
                $('#miniPlayerTitle').text(audio.title || 'æ— æ ‡é¢˜');
            }

            function deleteAudio(taskId) {
                $.ajax({
                    url: `${API_BASE_URL}/delete_task/${taskId}`,
                    method: 'DELETE',
                    success: function(response) {
                        fetchAudios();
                    },
                    error: function(error) {
                        console.error('åˆ é™¤ä»»åŠ¡å¤±è´¥:', error);
                        alert('åˆ é™¤ä»»åŠ¡å¤±è´¥');
                    }
                });
            }

            function updatePlayerControls() {
                $('#prevBtn').prop('disabled', currentAudioIndex <= 0);
                $('#nextBtn').prop('disabled', currentAudioIndex >= audioList.length - 1);
            }

            function togglePlayPause() {
                if (!sound) return;
                
                if (sound.playing()) {
                    sound.pause();
                } else {
                    const currentSeek = sound.seek();
                    sound.play();
                    
                    // ä¿æ¢å¤åˆ°æ­£ç¡®çš„ä½ç½®
                    if (currentSeek > 0) {
                        setTimeout(() => {
                            sound.seek(currentSeek);
                        }, 100);
                    }
                }
            }

            function playPrevious() {
                if (currentAudioIndex > 0) {
                    playAudio(currentAudioIndex - 1);
                }
            }

            function playNext() {
                if (currentAudioIndex < audioList.length - 1) {
                    playAudio(currentAudioIndex + 1);
                }
            }

            function updateProgressBar() {
                if (!sound) {
                    console.log('updateProgressBar: soundå¯¹è±¡ä¸å­˜åœ¨');
                    return;
                }
                
                const seek = sound.seek() || 0;
                const duration = sound.duration() || 0;
                
                
                if (duration > 0) {
                    const progress = (seek / duration) * 100;
                    $('#progressBar, #miniProgressBar').val(progress);
                    
                    const currentTimeText = formatTime(seek);
                    const durationText = formatTime(duration);
                    
                    $('#currentTime, #miniCurrentTime').text(currentTimeText);
                    $('#duration, #miniDuration').text(durationText);
                } else {
                    console.log('éŸ³é¢‘æ—¶é•¿ä¸º0ï¼Œæ— æ³•æ›´æ–°è¿›åº¦æ¡');
                }
                updateSubtitle();
            }

            function formatTime(seconds) {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = Math.floor(seconds % 60);
                return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
            }

            function handleSearch() {
                const searchTerm = $('#searchInput').val().toLowerCase();
                $('.audio-item').each(function() {
                    const title = $(this).find('.audio-title').text().toLowerCase();
                    if (title.includes(searchTerm)) {
                        $(this).show();
                    } else {
                        $(this).hide();
                    }
                });
            }

            function updatePlaylist() {
                const $playlist = $('#playlist');
                $playlist.empty();

                audioList.forEach((audio, index) => {
                    const $playlistItem = $('<div>')
                        .addClass(`playlist-item${index === currentAudioIndex ? ' active' : ''}`)
                        .text(audio.title || 'æ— æ ‡é¢˜')
                        .on('click', function() {
                            playAudio(index);
                        });
                    $playlist.append($playlistItem);
                });
            }

            const speedOptions = [0.75, 1, 1.25, 1.5, 1.75, 2];
            let currentSpeedIndex = speedOptions.indexOf(parseFloat(localStorage.getItem('audioPlaybackSpeed')) || 1);
            if (currentSpeedIndex === -1) currentSpeedIndex = 1;

            function updateSpeed(speed) {
                if (sound) {
                    sound.rate(speed);
                }
                // åŒæ—¶æ›´æ–°ä¸¤ä¸ªç•Œé¢çš„é€Ÿåº¦æŒ‰é’®æ–‡æœ¬
                $('#speedBtn, #miniSpeedBtn').text(speed + 'x');
                localStorage.setItem('audioPlaybackSpeed', speed);
            }

            function loadSubtitles(subtitleUrl, lang) {
                console.log(`å¼€å§‹åŠ è½½${lang}å­—å¹•:`, subtitleUrl);
                $.ajax({
                    url: subtitleUrl,
                    dataType: 'text',
                    success: function(data) {
                        subtitles[lang] = parseSRT(data);
                        console.log(`${lang}å­—å¹•åŠ è½½å®Œæˆ:`, subtitles[lang].length, 'æ¡');
                        // æ·»åŠ ä¸€äº›å­—å¹•å†…å®¹çš„æ—¥å¿—
                        if (subtitles[lang].length > 0) {
                            console.log('ç¬¬ä¸€æ¡å­—å¹•:', subtitles[lang][0]);
                            console.log('æœ€åä¸€æ¡å­—å¹•:', subtitles[lang][subtitles[lang].length - 1]);
                        }
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        console.error(`åŠ è½½${lang}å­—å¹•å¤±è´¥:`, textStatus, errorThrown);
                    }
                });
            }
            
            function parseSRT(srtContent) {
                srtContent = srtContent.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
                const blocks = srtContent.split('\n\n');
                const subtitles = [];
                
                blocks.forEach(block => {
                    if (!block.trim()) return;
                    
                    const lines = block.split('\n');
                    if (lines.length < 4) return; // ç¡®ä¿è‡³å°‘ç´¢å¼•ã€æ—¶é—´ç ã€ä¸­æ–‡å’Œè‹±æ–‡
                    
                    const timecode = lines[1].trim().split(' --> ');
                    if (timecode.length !== 2) return;
                    
                    try {
                        const startTime = timeToSeconds(timecode[0]);
                        const endTime = timeToSeconds(timecode[1]);
                        
                        const chineseText = lines[2].trim();
                        const englishText = lines[3].trim();
                        
                        subtitles.push({
                            index: parseInt(lines[0]),
                            start: startTime,
                            end: endTime,
                            textCn: chineseText,
                            textEn: englishText
                        });
                    } catch (e) {
                        console.error('è§£æå­—å¹•å—æ—¶å‡ºé”™:', e);
                        console.log('é—®é¢˜å­—å¹•å—:', block);
                    }
                });
                
                return subtitles;
            }
            
            function timeToSeconds(timeStr) {
                const [time, milliseconds] = timeStr.split(',');
                const [hours, minutes, seconds] = time.split(':');
                
                return (
                    parseInt(hours) * 3600 +
                    parseInt(minutes) * 60 +
                    parseInt(seconds) +
                    parseInt(milliseconds) / 1000
                );
            }
            
            let lastSubtitle = null;

            function updateSubtitle(forceUpdate = false) {
                if (!sound) {
                    return;
                }
                
                const currentTime = sound.seek();
                if (subtitles[currentLanguage].length === 0) {
                    return;
                }
                
                const currentSubtitle = subtitles[currentLanguage].find(sub => 
                    currentTime >= sub.start && currentTime <= sub.end
                );
                
                // å½“å­—å¹•å†…å®¹å‘ç”Ÿå˜åŒ–æˆ–å¼ºåˆ¶æ›´æ–°æ—¶æ‰æ›´æ–°æ˜¾ç¤º
                if (currentSubtitle !== lastSubtitle || forceUpdate) {
                    lastSubtitle = currentSubtitle;
                    
                    if (currentSubtitle) {
                        console.log('å­—å¹•æ›´æ–°:', currentSubtitle);
                        
                        switch(subtitleMode) {
                            case 'cn':
                                $('#subtitleTextCn').text(currentSubtitle.textCn).show();
                                $('#subtitleTextEn').hide();
                                break;
                            case 'en':
                                $('#subtitleTextCn').hide();
                                $('#subtitleTextEn').text(currentSubtitle.textEn).show();
                                break;
                            case 'both':
                                $('#subtitleTextCn').text(currentSubtitle.textCn).show();
                                $('#subtitleTextEn').text(currentSubtitle.textEn).show();
                                break;
                        }
                    } else {
                        console.log('å½“å‰æ— åŒ¹é…å­—å¹•');
                        $('#subtitleTextCn, #subtitleTextEn').text('');
                    }
                }
            }

            // ä¿®æ”¹è¯­è¨€åˆ‡æ¢å‡½æ•°
            function toggleLanguage() {
                currentLanguage = currentLanguage === 'cn' ? 'en' : 'cn';
                const languageText = currentLanguage === 'cn' ? 'ä¸­æ–‡' : 'English';
                $('#languageBtn, #miniLanguageBtn').text(languageText);
                
                console.log('åˆ‡æ¢è¯­è¨€åˆ°:', currentLanguage);
                
                if (currentAudioIndex !== -1) {
                    const audio = audioList[currentAudioIndex];
                    const subtitleUrl = currentLanguage === 'cn' ? audio.subtitleUrlCn : audio.subtitleUrlEn;
                    
                    console.log('å½“å‰éŸ³é¢‘å­—å¹•URL:', subtitleUrl);
                    
                    if (subtitleUrl) {
                        loadSubtitles(subtitleUrl, currentLanguage);
                    } else {
                        console.warn('å½“å‰è¯­è¨€æ²¡æœ‰å¯ç”¨çš„å­—å¹•URL');
                    }
                    
                    // å¼ºåˆ¶æ›´æ–°å­—å¹•æ˜¾ç¤º
                    updateSubtitle(true);
                    
                    playAudio(currentAudioIndex, true);
                }
            }

            fetchAudios();

            $('#urlForm').on('submit', function(e) {
                e.preventDefault();
                const url = $('#urlInput').val();
                
                console.log('æäº¤æ–°ä»»åŠ¡:', url); // è°ƒè¯•æ—¥å¿—
                
                $('#urlInput').val('');
                $('#taskInfo').empty();
                
                if (currentTaskId) {
                    console.log('å–æ¶ˆä¹‹å‰çš„ä»»åŠ¡:', currentTaskId); // è°ƒè¯•æ—¥å¿—
                    clearTimeout(window[`pollTimeout_${currentTaskId}`]);
                }
                
                $.ajax({
                    url: `${API_BASE_URL}/post_task`,
                    method: 'POST',
                    data: JSON.stringify({ url: url }),
                    contentType: 'application/json',
                    success: function(response) {
                        const taskId = response.taskId;
                        currentTaskId = taskId;
                        console.log('æ–°ä»»åŠ¡ID:', taskId); // è°ƒè¯•æ—¥å¿—
                        
                        $('#taskInfo').html(`
                            <div class="alert alert-info" id="task-${taskId}">
                                <div class="d-flex align-items-center">
                                    <div class="spinner-border spinner-border-sm me-2" role="status">
                                        <span class="visually-hidden">å¤„ç†ä¸­...</span>
                                    </div>
                                    <div>ä»»åŠ¡æ­£åœ¨å¤„ç†ä¸­...</div>
                                </div>
                                <div class="progress mt-2" style="height: 5px;">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                         role="progressbar" style="width: 100%"></div>
                                </div>
                            </div>
                        `);
                        
                        pollTaskStatus(taskId);
                    },
                    error: function(error) {
                        console.error('æäº¤ä»»åŠ¡å¤±è´¥:', error);
                        $('#taskInfo').html(`
                            <div class="alert alert-danger">
                                æäº¤ä»»åŠ¡å¤±è´¥ï¼Œè¯·é‡è¯•
                            </div>
                        `);
                    }
                });
            });

            function pollTaskStatus(taskId) {
                console.log('å¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€:', taskId); // è°ƒè¯•æ—¥å¿—
                
                const checkStatus = () => {
                    $.ajax({
                        url: `${API_BASE_URL}/get_task?taskId=${taskId}`,
                        method: 'GET',
                        success: function(task) {
                            console.log('è·å–ä»»åŠ¡çŠ¶æ€:', taskId, task.status); // è°ƒè¯•æ—¥å¿—
                            
                            updateTaskInfo(task, taskId);
                            
                            if (task.status === 'completed') {
                                fetchAudios();
                                setTimeout(() => {
                                    $(`#task-${taskId}`).fadeOut(500, function() {
                                        $(this).remove();
                                    });
                                }, 3000);
                            } else if (task.status === 'failed') {
                                setTimeout(() => {
                                    $(`#task-${taskId}`).fadeOut(500, function() {
                                        $(this).remove();
                                    });
                                }, 5000);
                            } else {
                                window[`pollTimeout_${taskId}`] = setTimeout(checkStatus, 2000);
                            }
                        },
                        error: function(error) {
                            console.error('è·å–åŠ¡çŠ¶æ€å¤±è´¥:', taskId, error);
                            $(`#task-${taskId}`).html(`
                                <div class="alert alert-danger">
                                    è·å–ä»»åŠ¡çŠ¶æ€å¤±è´¥
                                </div>
                            `);
                        }
                    });
                };
                
                checkStatus();
            }

            function updateTaskInfo(task, taskId) {
                console.log('æ›´æ–°ä»»åŠ¡ä¿¡æ¯:', taskId, task.status); // è°ƒè¯•æ—¥å¿—
                
                let alertClass = 'alert-info';
                let icon = 'spinner-border spinner-border-sm';
                let message = task.progress || 'å¤„ç†ä¸­...';
                
                if (task.status === 'completed') {
                    alertClass = 'alert-success';
                    icon = 'fas fa-check';
                    message = 'ä»»åŠ¡å·²å®Œæˆ';
                } else if (task.status === 'failed') {
                    alertClass = 'alert-danger';
                    icon = 'fas fa-times';
                    message = task.progress || 'ä»»åŠ¡å¤±è´¥';
                }
                
                $(`#task-${taskId}`).html(`
                    <div class="d-flex align-items-center">
                        <div class="me-2">
                            <i class="${icon}"></i>
                        </div>
                        <div>${message}</div>
                    </div>
                    ${task.status === 'processing' ? `
                        <div class="progress mt-2" style="height: 5px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 100%"></div>
                        </div>
                    ` : ''}
                `).removeClass('alert-info alert-success alert-danger').addClass(alertClass);
            }

            $('#playPauseBtn, #miniPlayPauseBtn').on('click', togglePlayPause);
            $('#prevBtn').on('click', playPrevious);
            $('#nextBtn, #miniNextBtn').on('click', playNext);
            $('#audioPlayer').on('timeupdate', updateProgressBar);
            $('#audioPlayer').on('ended', playNext);
            $('#searchInput').on('input', handleSearch);
            $('#backBtn').on('click', function() {
                $('#playerPage').hide();
                $('#mainPage').show();
                $('#miniPlayer').show();
            });

            // ä¿®æ”¹è¿›åº¦æ¡ç›¸å…³ä»£ç 
            let userSeekValue = 0;

            $('#progressBar, #miniProgressBar').on('input', function(e) {
                if (!sound) return;
                userSeekValue = this.value;
                const seekPosition = (userSeekValue / 100) * sound.duration();
                $('#currentTime, #miniCurrentTime').text(formatTime(seekPosition));
            });

            $('#progressBar, #miniProgressBar').on('mouseup touchend', function(e) {
                if (!sound) return;
                const seekPosition = (userSeekValue / 100) * sound.duration();
                sound.seek(seekPosition);
                if (!sound.playing()) {
                    sound.play();
                }
                updateProgressBar();
            });

            // æ·»åŠ é¼ æ ‡æŒ‰äº‹ä»¶å¤„ç†
            // $('#progressBar').on('mousedown touchstart', function() {
            //     if (!sound) return;
            //     sound.pause();
            // });

            // æ·»åŠ é¼ æ ‡é‡Šæ”¾äº‹ä»¶å¤„ç†
            // $('#progressBar').on('mouseup touchend', function() {
            //     if (!sound) return;
            //     sound.play();
            // });

            $('#speedBtn').on('click', function() {
                currentSpeedIndex = (currentSpeedIndex + 1) % speedOptions.length;
                const newSpeed = speedOptions[currentSpeedIndex];
                updateSpeed(newSpeed);
            });

            $('#audioPlayer').on('loadedmetadata', function() {
                updateProgressBar();
            });

            // æ·»åŠ è¿™äº›æ–°å‡½æ•°
            let progressInterval;

            function startProgressUpdate() {
                stopProgressUpdate(); // å…ˆæ¸…é™¤å¯èƒ½å­˜åœ¨çš„æ—§è®¡æ—¶å™¨
                progressInterval = setInterval(() => {
                    updateProgressBar();
                    updateSubtitle();
                }, 200); // é™ä½æ›´æ–°é¢‘ç‡åˆ°200æ¯«ç§’
            }

            function stopProgressUpdate() {
                if (progressInterval) {
                    clearInterval(progressInterval);
                    progressInterval = null;
                }
            }

            // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
            $('#miniOpenPlayerBtn').on('click', function() {
                $('#mainPage').hide();
                $('#playerPage').show();
                $('#miniPlayer').hide();
            });

            // ä¸º mini-player çš„è¿›åº¦æ·»åŠ äº‹ä»¶å¤„ç†
            $('#miniProgressBar').on('input', function(e) {
                if (!sound) return;
                
                const seekPosition = (this.value / 100) * sound.duration();
                $('#miniCurrentTime').text(formatTime(seekPosition));
            });

            $('#miniProgressBar').on('change', function(e) {
                if (!sound) return;
                
                const seekPosition = (this.value / 100) * sound.duration();
                
                // ä¿å­˜å½“å‰æ˜¯å¦æ­£åœ¨æ’­æ”¾çš„çŠ¶æ€
                const wasPlaying = sound.playing();
                
                // æš‚åœå½“å‰æ”¾
                sound.pause();
                
                // å°è¯• seek
                sound.seek(seekPosition);
                
                // å¦‚æœä¹‹å‰æ˜¯åœ¨æ’­æ”¾çŠ¶æ€ï¼Œåˆ™æ¢å¤æ’­æ”¾
                if (wasPlaying) {
                    setTimeout(() => {
                        sound.play();
                    }, 100);
                }
            });

            // æ·»åŠ é¼ æ ‡æŒ‰ä¸‹é‡Šæ”¾äº‹ä»¶å¤„ç†
            // $('#miniProgressBar').on('mousedown touchstart', function() {
            //     if (!sound) return;
            //     sound.pause();
            // });

            // $('#miniProgressBar').on('mouseup touchend', function() {
            //     if (!sound) return;
            //     sound.play();
            // });

            // ä¼˜åŒ–è¿›åº¦æ›´æ–°å‡½æ•°
            function updateProgressBar() {
                if (!sound) {
                    console.log('updateProgressBar: soundå¯¹è±¡ä¸å­˜åœ¨');
                    return;
                }
                
                const seek = sound.seek() || 0;
                const duration = sound.duration() || 0;
                
                
                if (duration > 0) {
                    const progress = (seek / duration) * 100;
                    $('#progressBar, #miniProgressBar').val(progress);
                    
                    const currentTimeText = formatTime(seek);
                    const durationText = formatTime(duration);
                    
                    $('#currentTime, #miniCurrentTime').text(currentTimeText);
                    $('#duration, #miniDuration').text(durationText);
                } else {
                    console.log('éŸ³é¢‘æ—¶é•¿ä¸º0ï¼Œæ— æ³•æ›´æ–°è¿›åº¦æ¡');
                }
                updateSubtitle();
            }

            // ç¡®ä¿åœ¨åˆ‡æ¢æ’­æ”¾æ—¶æ›´æ–°æ‰€æœ‰æ§ä»¶çŠ¶æ€
            function updatePlayPauseButtons() {
                const isPlaying = sound && sound.playing();
                const iconClass = isPlaying ? 'fa-pause' : 'fa-play';
                
                $('#playPauseBtn i, #miniPlayPauseBtn i')
                    .removeClass('fa-play fa-pause')
                    .addClass(iconClass);
            }

            // ä¿®æ”¹æ’­æ”¾/æš‚åœå‡½æ•°
            function togglePlayPause() {
                if (!sound) return;
                
                if (sound.playing()) {
                    sound.pause();
                } else {
                    sound.play();
                }
                
                updatePlayPauseButtons();
            }

            // æ·»åŠ å¼€å§‹æ’­æ”¾å‡½æ•°
            function startPlayback() {
                sound.play();
                updatePlaylist();
            }

            // ä¸ºä¸¤ä¸ªé€Ÿåº¦æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
            $('#speedBtn, #miniSpeedBtn').on('click', function() {
                currentSpeedIndex = (currentSpeedIndex + 1) % speedOptions.length;
                const newSpeed = speedOptions[currentSpeedIndex];
                updateSpeed(newSpeed);
            });

            // åˆå§‹åŒ–é€Ÿåº¦æŒ‰é’®æ˜¾ç¤º
            const initialSpeed = parseFloat(localStorage.getItem('audioPlaybackSpeed')) || 1;
            $('#speedBtn, #miniSpeedBtn').text(initialSpeed + 'x');

            $('#languageBtn, #miniLanguageBtn').on('click', toggleLanguage);

            // ä¿®æ”¹å­—å¹•æ¨¡å¼ï¿½ï¿½æ¢çš„å¤„ç†
            $('#subtitleBtn').on('click', function() {
                switch(subtitleMode) {
                    case 'both':
                        subtitleMode = 'cn';
                        $(this).text('å­—å¹•: ä¸­æ–‡');
                        break;
                    case 'cn':
                        subtitleMode = 'en';
                        $(this).text('å­—å¹•: è‹±æ–‡');
                        break;
                    case 'en':
                        subtitleMode = 'both';
                        $(this).text('å­—å¹•: ä¸­è‹±æ–‡');
                        break;
                }
                // å¼ºåˆ¶æ›´æ–°å­—å¹•æ˜¾ç¤º
                updateSubtitle(true);
            });

            // åœ¨ $(document).ready() å‡½æ•°çš„æœ€åæ·»åŠ ï¼š
            console.log('Document ready, initializing...');

            // ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½
            const themeToggle = $('#themeToggle');
            const body = $('body');

            // æ£€æŸ¥æœ¬åœ°å­˜å‚¨ä¸­ï¿½ï¿½ï¿½ä¸»é¢˜è®¾ç½®
            const currentTheme = localStorage.getItem('theme');
            if (currentTheme) {
                body.addClass(currentTheme);
            }

            themeToggle.on('click', function() {
                if (body.hasClass('light-mode')) {
                    body.removeClass('light-mode').addClass('dark-mode');
                    localStorage.setItem('theme', 'dark-mode');
                } else {
                    body.removeClass('dark-mode').addClass('light-mode');
                    localStorage.setItem('theme', 'light-mode');
                }
            });

            // æ ¹æ®ç³»ç»Ÿä¸»é¢˜è®¾ç½®åˆå§‹ä¸»é¢˜
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                body.addClass('dark-mode');
                localStorage.setItem('theme', 'dark-mode');
            } else {
                body.addClass('light-mode');
                localStorage.setItem('theme', 'light-mode');
            }
        });
    </script>
</body>
</html>
